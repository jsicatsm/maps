<!DOCTYPE html>
<html>
<head>
  <title>Travel Planner</title>
  <style>
    body { font-family: sans-serif; }
    #map { height: 75vh; width: 100%; }
    #controls {
      padding: 10px;
      background: #f9f9f9;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    textarea { vertical-align: middle; }
    #saved-list { margin: 10px; }
  </style>
</head>
<body>
  <div id="controls">
    <input id="place-search" type="text" placeholder="Search a place" size="40">
    <input type="date" id="visit-date">
    <textarea id="notes" placeholder="Add notes..." rows="2" cols="30"></textarea>
    <button onclick="saveLocation()">Add To-Go</button>
    <select id="day-selector" onchange="drawRoutesForDay()">
      <option value="">-- Select a Day to Show Route --</option>
    </select>
  </div>

  <div id="map"></div>
  <div id="saved-list"></div>

  <script>
    let map, marker, selectedPlace;
    let savedLocations = JSON.parse(localStorage.getItem("savedLocations") || "[]");

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 1.3521, lng: 103.8198 },
        zoom: 12
      });

      const input = document.getElementById("place-search");
      const searchBox = new google.maps.places.SearchBox(input);
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

      searchBox.addListener("places_changed", () => {
        const places = searchBox.getPlaces();
        if (places.length === 0) return;

        selectedPlace = places[0];
        const location = selectedPlace.geometry.location;

        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({
          map,
          title: selectedPlace.name,
          position: location
        });

        map.panTo(location);
      });

      refreshSavedList();
    }

    function saveLocation() {
      if (!selectedPlace) {
        alert("Please search for a place first.");
        return;
      }

      const date = document.getElementById("visit-date").value;
      if (!date) {
        alert("Please choose a date.");
        return;
      }

      const notes = document.getElementById("notes").value;

      const locationData = {
        id: Date.now(),
        name: selectedPlace.name,
        lat: selectedPlace.geometry.location.lat(),
        lng: selectedPlace.geometry.location.lng(),
        date,
        notes
      };

      savedLocations.push(locationData);
      localStorage.setItem("savedLocations", JSON.stringify(savedLocations));
      alert(`Saved "${locationData.name}" for ${date}`);
      refreshSavedList();
      updateDaySelector();
    }

    function refreshSavedList() {
      const listDiv = document.getElementById("saved-list");
      listDiv.innerHTML = "<h3>Saved Locations:</h3>";

      savedLocations.forEach(loc => {
        const el = document.createElement("div");
        el.innerHTML = `<strong>${loc.name}</strong> â€” ${loc.date}<br><em>${loc.notes}</em>`;
        listDiv.appendChild(el);
      });
    }

    function updateDaySelector() {
      const daySelector = document.getElementById("day-selector");
      const dates = [...new Set(savedLocations.map(l => l.date))];

      daySelector.innerHTML = `<option value="">-- Select a Day to Show Route --</option>`;
      dates.forEach(date => {
        const opt = document.createElement("option");
        opt.value = date;
        opt.textContent = date;
        daySelector.appendChild(opt);
      });
    }

    function drawRoutesForDay() {
      const selectedDate = document.getElementById("day-selector").value;
      const dayLocations = savedLocations.filter(l => l.date === selectedDate);

      if (dayLocations.length < 2) {
        alert("You need at least 2 locations on this day to draw a route.");
        return;
      }

      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);

      const origin = dayLocations[0];
      const destination = dayLocations[dayLocations.length - 1];
      const waypoints = dayLocations.slice(1, -1).map(loc => ({
        location: new google.maps.LatLng(loc.lat, loc.lng),
        stopover: true
      }));

      directionsService.route({
        origin: new google.maps.LatLng(origin.lat, origin.lng),
        destination: new google.maps.LatLng(destination.lat, destination.lng),
        waypoints: waypoints,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
        } else {
          alert("Could not draw route: " + status);
        }
      });
    }

    window.onload = () => {
      updateDaySelector();
    };
  </script>

  <!-- Replace YOUR_API_KEY with your actual key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVMx_F4MGIaNXMcRvyuavcm_S5BUgZDw4&libraries=places&callback=initMap" async defer></script>
</body>
</html>
