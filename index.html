<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel Planner with OpenStreetMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 90vh; }
    #controls { padding: 10px; background: #f4f4f4; }
    .popup-form input, .popup-form textarea, .popup-form button { display: block; width: 100%; margin-top: 5px; }
  </style>
</head>
<body>

<div id="controls">
  ğŸ” <input type="text" id="searchBox" placeholder="Search place..." />
  <button onclick="searchPlace()">Search</button>
  <button onclick="clearAll()">Clear All</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const ORS_API_KEY = "5b3ce3597851110001cf62489b2edba376c34275a27c88bde7643bc6"; // <-- Replace this

  let map = L.map('map').setView([1.3521, 103.8198], 12); // Singapore default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  let markers = [];
  let visitData = JSON.parse(localStorage.getItem('visitData')) || [];

  function addMarker(lat, lon, name, date = '', note = '') {
    const marker = L.marker([lat, lon], { draggable: false }).addTo(map);
    marker.bindTooltip(note || name, { permanent: false, direction: "top" });
    marker.visitInfo = { lat, lon, name, date, note };

    marker.on('click', () => {
      const content = document.createElement('div');
      content.className = 'popup-form';
      content.innerHTML = `
        <strong>${name}</strong><br/>
        ğŸ“… <input type="date" value="${date}" id="dateInput" />
        ğŸ“ <textarea id="noteInput" placeholder="Enter note...">${note}</textarea>
        <button onclick="saveInfo(${lat}, ${lon})">Save</button>
        <button onclick="deleteMarker(${lat}, ${lon})">Delete</button>
      `;
      marker.bindPopup(content).openPopup();
    });

    markers.push(marker);
    visitData.push({ lat, lon, name, date, note });
    saveToStorage();
    updateRoutes();
  }

  function saveToStorage() {
    localStorage.setItem('visitData', JSON.stringify(visitData));
  }

  function restoreMarkers() {
    visitData.forEach(({ lat, lon, name, date, note }) => {
      addMarker(lat, lon, name, date, note);
    });
  }

  function saveInfo(lat, lon) {
    const date = document.getElementById('dateInput').value;
    const note = document.getElementById('noteInput').value;
    visitData = visitData.map(v => v.lat === lat && v.lon === lon ? { ...v, date, note } : v);
    saveToStorage();
    location.reload();
  }

  function deleteMarker(lat, lon) {
    visitData = visitData.filter(v => v.lat !== lat || v.lon !== lon);
    saveToStorage();
    location.reload();
  }

  function clearAll() {
    localStorage.removeItem('visitData');
    location.reload();
  }

  async function searchPlace() {
    const query = document.getElementById('searchBox').value;
    if (!query) return alert("Enter a place");
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (!data.length) return alert("Place not found!");
    const { lat, lon, display_name } = data[0];
    map.setView([lat, lon], 15);
    addMarker(lat, lon, display_name);
  }

  async function updateRoutes() {
    // Remove old routes
    document.querySelectorAll('.route-line').forEach(el => el.remove());

    const groupedByDate = {};
    visitData.forEach(item => {
      if (!item.date) return;
      if (!groupedByDate[item.date]) groupedByDate[item.date] = [];
      groupedByDate[item.date].push(item);
    });

    for (const date in groupedByDate) {
      const coords = groupedByDate[date].map(p => [parseFloat(p.lon), parseFloat(p.lat)]);
      if (coords.length < 2) continue;

      const body = {
        coordinates: coords,
        instructions: false,
      };

      try {
        const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
          method: "POST",
          headers: {
            "Authorization": ORS_API_KEY,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        const geojson = await res.json();
        const routeLayer = L.geoJSON(geojson, {
          style: { color: "blue", weight: 3 },
          className: 'route-line'
        }).addTo(map);

      } catch (err) {
        console.error("Routing error:", err);
      }
    }
  }

  restoreMarkers();
</script>
</body>
</html>

